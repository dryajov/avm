include $(DZ_PROJECT_PATH)/include.mk

DZ_PKG_BUILD_SCRIPT = $(DZ_PROJECT_PATH)/build_pkg/dz_prepkg.sh
DZ_RPM_BUILD_SCRIPT = $(DZ_PROJECT_PATH)/build_pkg/dz_makerpm.sh

DZ_PACKAGE_DIR_BASE = $(DZ_PROJECT_PATH)/packaging
DZ_PACKAGE_DIR_SHIP_BASE = $(DZ_PACKAGE_DIR_BASE)
DZ_PACKAGE_DIR_SHIP_COMPLETE = $(DZ_PACKAGE_DIR_SHIP_BASE)/release


#DZ_PACKAGE_NAME_BASE = avm
DZ_PACKAGE_NAME_BASE = zaidstor_databank
#DZ_PACKAGE_NAME_BASE = "zaidstor_databank_""`date +'%d_%m_%Y_%H_%M_%S'`"
DZ_PACKAGE_NAME_SHIP_COMPLETE = $(DZ_PACKAGE_NAME_BASE)
DZ_PACKAGE_NAME_SHIP_SOURCE_CODE = avm_src

#########################################################################
# Kernel Module Generation
#########################################################################
ARG_TARGET_KERNEL_SRC_PATH  = /home/averma/kernel/linux-3.10.1/linux-3.10.1 

OBJ_FILES                   := $(SRC_FILES:.c=.o)
EXTRA_CFLAGS                +=-g -I $(DZ_HEADERS_PATH) -I $(DZ_HASH_PATH) -I . -DDZ_BIT_SPIN_LOCK -Wall -Werror -Wfatel-errors

KERNEL_MODULE_NAME           = datumsoft_zaidstor_avm_aisa_target_module
$(KERNEL_MODULE_NAME)-objs   = $(OBJ_FILES)
obj-m                       := $(KERNEL_MODULE_NAME).o


.PHONY: subdirs $(DZ_SUBDIRS) tag

infra:
	@echo ""
	@echo "#########################################"
	@echo "2/11 - Building AVM Infrastructure Engine"
	@date
	@echo "#########################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/infra_engine modules
	@echo ""
	@cp $(PWD)/infra_engine/*.ko .
	@echo ""
	@date

lab:infra
	@echo ""
	@echo "#########################################"
	@echo "3/11 - Building AVM LAB Engine"
	@date
	@echo "#########################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/lab_engine modules
	@echo ""
	@cp $(PWD)/lab_engine/*.ko .
	@echo ""
	@date

bec:lab
	@echo ""
	@echo "###############################################"
	@echo "4/11 - Building AVM BEC (Back End Cache) Engine"
	@date
	@echo "###############################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/bec_engine modules
	@echo ""
	@cp $(PWD)/bec_engine/*.ko .
	@echo ""
	@date

md:bec
	@echo ""
	@echo "###############################################"
	@echo "5/11 - Building AVM MetaData Engine"
	@date
	@echo "###############################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/metadata_engine modules
	@echo ""
	@cp $(PWD)/metadata_engine/*.ko .
	@echo ""
	@date


dedupe:md
	@echo ""
	@echo "###############################################"
	@echo "6/11 - Building AVM Dedupe Engine"
	@date
	@echo "###############################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/dedupe_engine modules
	@echo ""
	@cp $(PWD)/dedupe_engine/*.ko .
	@echo ""
	@date

fec:dedupe
	@echo ""
	@echo "################################################"
	@echo "7/11 - Building AVM FEC (Front End Cache) Engine"
	@date
	@echo "################################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/fec_engine modules
	@echo ""
	@cp $(PWD)/fec_engine/*.ko .
	@echo ""
	@date

ae:fec
	@echo ""
	@echo "################################################"
	@echo "8/11 - Building AVM Alignment Engine"
	@date
	@echo "################################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/alignment_engine modules
	@echo ""
	@cp $(PWD)/alignment_engine/*.ko .
	@echo ""
	@date


target:ae
	@echo ""
	@echo "################################################"
	@echo "9/11 - Building AVM Target Engine"
	@date
	@echo "################################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/target_engine modules
	@echo ""
	@cp $(PWD)/target_engine/*.ko .
	@echo ""
	@date

volume:target
	@echo ""
	@echo "################################################"
	@echo "10/11 - Building AVM Volume Engine"
	@date
	@echo "################################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/volume_engine modules
	@echo ""
	@cp $(PWD)/volume_engine/*.ko .
	@echo ""
	@date
	
sysfs:volume
	@echo ""
	@echo "################################################"
	@echo "11/11 - Building AVM Sysfs Engine"
	@date
	@echo "################################################"
	@echo ""
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/sysfs_engine modules
	@echo ""
	cp $(PWD)/sysfs_engine/*.ko .
	@echo ""
	date

KERNEL_MODULES := $(DZ_LOG_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_INFRA_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_BEC_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_METADATA_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_DEDUPE_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_FEC_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_TARGET_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_VOLUME_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_SYSFS_ENGINE_KERNEL_MODULE_NAME).ko
KERNEL_MODULES += $(DZ_LAB_ENGINE_KERNEL_MODULE_NAME).ko

#all:$(KERNEL_MODULES)
alld:tags sysfs
	logger `date`
	@echo ""
	@echo "##################################################################################"
	@echo "List and Checksum of Kernel Modules generated" 
	@echo "##################################################################################"
	@cksum *.ko
	@echo "##################################################################################"
	@echo "Compilation Done"
	@date
	@echo "##################################################################################"

d:alld




all:sysfs
	logger `date`
	@echo ""
	@echo "##################################################################################"
	@echo "List and Checksum of Kernel Modules generated" 
	@echo "##################################################################################"
	@cksum *.ko
	@echo "##################################################################################"
	@echo "Compilation Done"
	@date
	@echo "##################################################################################"

clean:

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Log Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/log_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Infra Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/infra_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning LAB Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/lab_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning BEC Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/bec_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning FEC Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/fec_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Alignment Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/alignment_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Dedupe Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/dedupe_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Metadata Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/metadata_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Target Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/target_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Volume Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/volume_engine clean > /dev/null

	@echo ""
	@echo "#########################################################"
	@echo "Cleaning Sysfs Engine" `date`
	@echo "#########################################################"
	make -C $(ARG_TARGET_KERNEL_SRC_PATH) M=$(PWD)/sysfs_engine clean > /dev/null

	@rm -rf $(OBJ_FILES)
	@rm -rf objdump.txt
	@rm -rf *.ko
	@echo ""
	@echo "#########################################"
	@echo "Cleaning Completed"
	@date
	@echo "#########################################"
